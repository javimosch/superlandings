<!-- Version History Modal -->
<div v-if="showVersionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 sm:p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
    <div class="px-4 sm:px-6 py-3 sm:py-4 bg-gray-50 border-b flex justify-between items-center">
      <div class="flex-1 min-w-0">
        <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Version History</h3>
        <p class="text-xs sm:text-sm text-gray-500 mt-1 truncate">{{ versionLanding?.name }}</p>
      </div>
      <button @click="closeVersionsModal" class="text-gray-500 hover:text-gray-700 flex-shrink-0">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <div class="p-4 sm:p-6 flex-1 overflow-y-auto">
      <!-- Create Snapshot Button -->
      <div class="mb-4 flex gap-2 flex-col sm:flex-row">
        <input v-model="newVersionDescription" type="text" placeholder="Version description (optional)" 
               class="flex-1 px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-xs sm:text-sm">
        <button @click="createSnapshot" :disabled="loading.createVersion" 
                class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-xs sm:text-sm font-medium flex-shrink-0">
          <span v-if="loading.createVersion">Creating...</span>
          <span v-else>üì∏ Create Snapshot</span>
        </button>
      </div>

      <!-- Versions List -->
      <div v-if="versions.length === 0" class="text-center py-12 text-gray-500">
        <p class="text-lg">No versions yet</p>
        <p class="text-sm mt-2">Versions are automatically created when you edit a landing</p>
      </div>

      <div v-else class="space-y-3">
        <div v-for="(version, index) in versions" :key="version.id" 
             :data-version-id="version.id"
             class="border rounded-lg p-4 hover:bg-gray-50 transition"
             :class="{ 'border-blue-300 bg-blue-50': index === 0 }">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2 flex-wrap">
                <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-bold">
                  Version {{ version.versionNumber || '?' }}
                </span>
                <span v-if="index === 0" class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">Latest</span>
                <span v-if="version.description && version.description.includes('Before')" class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-medium">
                  üìã Before Edit
                </span>
                <span v-else-if="version.description && version.description.includes('After')" class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                  ‚ú® After Edit
                </span>
                <span v-if="version.tag" class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium flex items-center gap-1">
                  üè∑Ô∏è {{ version.tag }}
                  <button @click="removeTag(version)" class="ml-1 text-green-600 hover:text-green-800" title="Remove tag">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </span>
                <button v-if="!version.tag" @click="startEditTag(version)" 
                        class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200 transition" 
                        title="Add tag">
                  + Tag
                </button>
              </div>
              
              <!-- Description editing -->
              <div class="mb-2">
                <div v-if="editingVersionDescription && editingVersionId === version.id" class="flex gap-2">
                  <input :ref="`desc-input-${version.id}`" v-model="tempDescription" 
                         @keyup.enter="saveDescription" @keyup.esc="cancelEditDescription"
                         class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         placeholder="Enter description...">
                  <button @click="saveDescription" 
                          class="px-2 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                    ‚úì
                  </button>
                  <button @click="cancelEditDescription" 
                          class="px-2 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                    ‚úï
                  </button>
                </div>
                <div v-else class="flex items-center gap-2">
                  <div v-if="version.description" class="text-sm text-gray-700 italic cursor-pointer hover:text-gray-900" 
                       @click="startEditDescription(version)" title="Click to edit">
                    "{{ version.description }}"
                  </div>
                  <div v-else class="text-sm text-gray-400 cursor-pointer hover:text-gray-600" 
                       @click="startEditDescription(version)" title="Click to add description">
                    + Add description
                  </div>
                </div>
              </div>
              
              <!-- Tag editing -->
              <div v-if="editingVersionTag && editingVersionId === version.id" class="flex gap-2 mb-2">
                <input :ref="`tag-input-${version.id}`" v-model="tempTag" 
                       @keyup.enter="saveTag" @keyup.esc="cancelEditTag"
                       class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       placeholder="e.g. Stable, 1.0.0, Production">
                <button @click="saveTag" 
                        class="px-2 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition">
                  ‚úì
                </button>
                <button @click="cancelEditTag" 
                        class="px-2 py-1 text-sm bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition">
                  ‚úï
                </button>
              </div>
              
              <div class="text-sm text-gray-500 flex items-center gap-4">
                <span>{{ formatVersionDate(version.createdAt) }}</span>
                <span>{{ formatBytes(version.size) }}</span>
                <span class="uppercase text-xs px-2 py-0.5 bg-gray-100 rounded">{{ version.landingType }}</span>
                <span v-if="version.tag" class="text-xs text-green-600 font-medium">üîí Protected</span>
              </div>
            </div>
            <div class="flex gap-2 flex-wrap justify-end">
              <!-- View HTML button -->
              <button v-if="version.landingType === 'html'" 
                      @click="viewVersionHtml(version)" 
                      :disabled="loading['html-' + version.id]"
                      class="px-3 py-1 bg-cyan-100 text-cyan-700 rounded text-sm hover:bg-cyan-200 disabled:opacity-50">
                <span v-if="loading['html-' + version.id]">...</span>
                <span v-else>&lt;/&gt; HTML</span>
              </button>
              <!-- Diff button -->
              <button @click="openDiffModal(version)" 
                      :disabled="loading['diff-' + version.id]"
                      class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm hover:bg-indigo-200 disabled:opacity-50">
                <span v-if="loading['diff-' + version.id]">Loading...</span>
                <span v-else>üìä Diff</span>
              </button>
              <!-- Preview button (HTML only) -->
              <button v-if="version.landingType === 'html'" 
                      @click="previewVersion(version)" 
                      class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                üëÅÔ∏è Preview
              </button>
              <!-- Rollback button -->
              <button @click="rollbackToVersion(version)" 
                      :disabled="loading['rollback-' + version.id]"
                      class="px-3 py-1 bg-orange-100 text-orange-700 rounded text-sm hover:bg-orange-200 disabled:opacity-50">
                <span v-if="loading['rollback-' + version.id]">...</span>
                <span v-else>üîÑ Rollback</span>
              </button>
              <!-- Delete button -->
              <button @click="deleteVersionItem(version)" 
                      :disabled="loading['delete-' + version.id] || version.tag || versions.length <= 1"
                      :title="versions.length <= 1 ? 'Cannot delete the last version' : (version.tag ? 'Tagged versions cannot be deleted' : 'Delete version')"
                      class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed">
                <span v-if="loading['delete-' + version.id]">...</span>
                <span v-else>üóëÔ∏è</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-t">
      <p class="text-xs text-gray-500">
        Versions are automatically created before each edit. Maximum 10 versions are kept per landing.
        Tagged versions are protected from deletion and excluded from cleanup. Click on descriptions or tags to edit them.
      </p>
    </div>
  </div>
</div>

<!-- Rollback Confirmation Modal -->
<div v-if="showRollbackConfirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mr-4">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Confirm Rollback</h3>
          <p class="text-sm text-gray-500">This action will replace the current landing content</p>
        </div>
      </div>
      
      <div class="mb-6">
        <p class="text-gray-700">
          Are you sure you want to rollback to 
          <span class="font-semibold">Version {{ confirmingVersion?.versionNumber }}</span>
          <span v-if="confirmingVersion?.tag" class="text-green-600 font-medium"> ({{ confirmingVersion.tag }})</span>
          <span v-if="confirmingVersion?.description"> "{{ confirmingVersion.description }}"</span>?
        </p>
        <p class="text-sm text-gray-500 mt-2">
          Created: {{ confirmingVersion ? formatVersionDate(confirmingVersion.createdAt) : '' }}
          <span v-if="confirmingVersion?.tag"> ‚Ä¢ Tagged version (protected from deletion)</span>
        </p>
      </div>
      
      <div class="flex gap-3">
        <button @click="showRollbackConfirm = false; confirmingVersion = null" 
                class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
          Cancel
        </button>
        <button @click="confirmRollback" 
                class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-medium">
          Rollback to Version {{ confirmingVersion?.versionNumber }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div v-if="showDeleteConfirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
    <div class="p-6">
      <div class="flex items-center mb-4">
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Confirm Delete</h3>
          <p class="text-sm text-gray-500">This action cannot be undone</p>
        </div>
      </div>
      
      <div class="mb-6">
        <p class="text-gray-700">
          Are you sure you want to permanently delete 
          <span class="font-semibold">Version {{ confirmingVersion?.versionNumber }}</span>
          <span v-if="confirmingVersion?.tag" class="text-green-600 font-medium"> ({{ confirmingVersion.tag }})</span>
          <span v-if="confirmingVersion?.description"> "{{ confirmingVersion.description }}"</span>?
        </p>
        <p class="text-sm text-gray-500 mt-2">
          Created: {{ confirmingVersion ? formatVersionDate(confirmingVersion.createdAt) : '' }} ‚Ä¢ 
          Size: {{ confirmingVersion ? formatBytes(confirmingVersion.size) : '' }}
        </p>
        <p v-if="confirmingVersion?.tag" class="text-sm text-red-600 mt-2 font-medium">
          ‚ö†Ô∏è This is a tagged version. Tagged versions are normally protected from deletion.
        </p>
        <p v-else-if="versions.length <= 1" class="text-sm text-red-600 mt-2 font-medium">
          ‚ö†Ô∏è This is the last version. You cannot delete the only version of a landing page.
        </p>
      </div>
      
      <div class="flex gap-3">
        <button @click="showDeleteConfirm = false; confirmingVersion = null" 
                class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
          Cancel
        </button>
        <button @click="confirmDelete" 
                :disabled="versions.length <= 1"
                class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed">
          Delete Version {{ confirmingVersion?.versionNumber }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Version Preview Modal (Visual) -->
<div v-if="showVersionPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col">
    <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Version Preview</h3>
        <p class="text-sm text-gray-500">
          Version {{ previewingVersion?.versionNumber }} 
          <span v-if="previewingVersion?.description">- {{ previewingVersion.description }}</span>
        </p>
      </div>
      <button @click="showVersionPreviewModal = false" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <div class="flex-1 overflow-hidden">
      <iframe :srcdoc="versionPreviewContent" class="w-full h-full min-h-[500px] border-0"></iframe>
    </div>
  </div>
</div>

<!-- Version HTML View Modal -->
<div v-if="showVersionHtmlModal" class="fixed inset-0 bg-gray-900 z-50 flex flex-col">
  <div class="bg-gray-800 text-white px-6 py-4 flex justify-between items-center border-b border-gray-700">
    <div>
      <h2 class="text-xl font-semibold">HTML Source</h2>
      <p class="text-sm text-gray-400 mt-1">
        Version {{ viewingHtmlVersion?.versionNumber }}
        <span v-if="viewingHtmlVersion?.description" class="ml-2">- {{ viewingHtmlVersion.description }}</span>
      </p>
    </div>
    <div class="flex items-center gap-4">
      <button @click="copyVersionHtml" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition text-sm font-medium">
        üìã Copy HTML
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-auto p-4 bg-gray-900">
    <pre class="text-sm text-gray-300 font-mono whitespace-pre-wrap break-all"><code>{{ versionHtmlContent }}</code></pre>
  </div>

  <div class="bg-gray-800 px-6 py-4 border-t border-gray-700 flex justify-end">
    <button @click="showVersionHtmlModal = false" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
      Close
    </button>
  </div>
</div>
